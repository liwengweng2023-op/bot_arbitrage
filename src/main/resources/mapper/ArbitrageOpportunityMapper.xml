<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.codingnomads.bot.arbitrage.mapper.ArbitrageOpportunityMapper">
    
    <resultMap id="ArbitrageOpportunityResultMap" type="co.codingnomads.bot.arbitrage.model.ArbitrageOpportunity">
        <id column="id" property="id"/>
        <result column="symbol" property="symbol"/>
        <result column="buy_exchange" property="buyExchange"/>
        <result column="sell_exchange" property="sellExchange"/>
        <result column="buy_price" property="buyPrice"/>
        <result column="sell_price" property="sellPrice"/>
        <result column="profit_margin" property="profitMargin"/>
        <result column="profit_amount" property="profitAmount"/>
        <result column="detected_at" property="detectedAt"/>
    </resultMap>

    <!-- 插入套利机会 -->
    <insert id="insertArbitrageOpportunity" parameterType="co.codingnomads.bot.arbitrage.model.ArbitrageOpportunity" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO arbitrage_opportunities (symbol, buy_exchange, sell_exchange, buy_price, sell_price, profit_margin, profit_amount, detected_at)
        VALUES (#{symbol}, #{buyExchange}, #{sellExchange}, #{buyPrice}, #{sellPrice}, #{profitMargin}, #{profitAmount}, #{detectedAt})
    </insert>

    <!-- 获取最新的套利机会 -->
    <select id="getLatestOpportunities" resultMap="ArbitrageOpportunityResultMap">
        SELECT * FROM arbitrage_opportunities
        <where>
            <if test="symbol != null and symbol != ''">
                AND symbol = #{symbol}
            </if>
        </where>
        ORDER BY detected_at DESC
        <if test="limit > 0">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 获取今日套利机会统计 -->
    <select id="getTodayOpportunityCount" resultType="int">
        SELECT COUNT(*) FROM arbitrage_opportunities
        WHERE DATE(detected_at) = CURDATE()
    </select>

</mapper>
